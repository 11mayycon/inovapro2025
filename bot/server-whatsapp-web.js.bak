import express from 'express';
import cors from 'cors';
import https from 'https';
import pkg from 'whatsapp-web.js';
const { Client, LocalAuth } = pkg;
import qrcode from 'qrcode-terminal';
import moment from 'moment-timezone';
import fs from 'fs';
import path from 'path';
import pdf from 'puppeteer';
import dotenv from 'dotenv';
// Importar m√≥dulo de IA
import { askGroq, isAIQuestion, cleanQuestion } from './modules/ai/groq.js';

// Carregar vari√°veis de ambiente
dotenv.config();

const app = express();
app.use(cors());
app.use(express.json());

// Configurar moment para portugu√™s e timezone de S√£o Paulo
moment.locale('pt-br');
moment.tz.setDefault('America/Sao_Paulo');

// Configurar cliente com sess√£o persistente e reconex√£o
const client = new Client({
  authStrategy: new LocalAuth({
    clientId: 'caminho-certo-bot'
  }),
  puppeteer: {
    headless: true,
    args: [
      '--no-sandbox',
      '--disable-setuid-sandbox',
      '--disable-dev-shm-usage',
      '--disable-accelerated-2d-canvas',
      '--no-first-run',
      '--no-zygote',
      '--disable-gpu',
      '--disable-extensions',
      '--disable-software-rasterizer',
      '--disable-background-timer-throttling',
      '--disable-backgrounding-occluded-windows',
      '--disable-renderer-backgrounding'
    ]
  },
  webVersionCache: {
    type: 'remote',
    remotePath: 'https://raw.githubusercontent.com/wppconnect-team/wa-version/main/html/2.2412.54.html',
  }
});

let isClientReady = false;
let reconnectAttempts = 0;
const MAX_RECONNECT_ATTEMPTS = 5;

client.on('qr', qr => {
  console.log('üì± Escaneie o QR Code do WhatsApp...');
  qrcode.generate(qr, { small: true });
  reconnectAttempts = 0; // Reset counter when QR is shown
});

client.on('ready', () => {
  console.log('‚úÖ Bot do Caminho Certo conectado ao WhatsApp!');
  console.log('üì± Sess√£o salva e pronta para uso!');
  isClientReady = true;
  reconnectAttempts = 0;
});

client.on('authenticated', () => {
  console.log('üîê Bot autenticado com sucesso!');
  console.log('üíæ Sess√£o salva localmente');
});

client.on('auth_failure', msg => {
  console.error('‚ùå Falha na autentica√ß√£o:', msg);
  console.log('üîÑ Tentando reconectar...');
  reconnectAttempts++;

  if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
    setTimeout(() => {
      console.log(`üîÑ Tentativa de reconex√£o ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS}`);
      client.initialize();
    }, 5000);
  } else {
    console.error('‚ùå M√°ximo de tentativas de reconex√£o atingido');
    console.log('‚ö†Ô∏è Por favor, escaneie o QR Code novamente');
  }
});

client.on('disconnected', (reason) => {
  console.log('‚ùå Bot desconectado:', reason);
  isClientReady = false;

  // Tentar reconectar automaticamente
  if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
    reconnectAttempts++;
    console.log(`üîÑ Tentando reconectar (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})...`);

    setTimeout(() => {
      console.log('üîÑ Reinicializando cliente...');
      client.initialize();
    }, 5000);
  } else {
    console.error('‚ùå M√°ximo de tentativas de reconex√£o atingido');
    console.log('‚ö†Ô∏è Reinicie o servidor manualmente');
  }
});

client.on('loading_screen', (percent, message) => {
  console.log('‚è≥ Carregando WhatsApp:', percent, '%', message);
});

// Evento de mudan√ßa de estado
client.on('change_state', state => {
  console.log('üîÑ Estado alterado:', state);
});

// Keepalive para manter a conex√£o ativa
setInterval(() => {
  if (isClientReady) {
    client.getState().then(state => {
      console.log('üíö Conex√£o ativa:', state);
    }).catch(err => {
      console.log('‚ö†Ô∏è Erro ao verificar estado:', err.message);
    });
  }
}, 60000); // Verifica a cada 1 minuto

console.log('üîÑ Inicializando cliente WhatsApp...');
console.log('üíæ Usando sess√£o salva: caminho-certo-bot');
client.initialize();

// ============================================
// ü§ñ INOVAPRO SMART MANAGER - M√ìDULO DE IA
// ============================================
// Handler de mensagens para funcionalidade de IA
client.on('message', async (msg) => {
  try {
    // Ignorar mensagens de grupos e mensagens pr√≥prias
    if (msg.from.includes('@g.us') || msg.fromMe) {
      return;
    }

    const messageBody = msg.body.trim();
    
    // Verificar se √© uma pergunta para IA
    if (isAIQuestion(messageBody)) {
      console.log(`ü§ñ Pergunta para IA recebida de ${msg.from}: ${messageBody}`);
      
      // Limpar a pergunta removendo prefixos
      const pergunta = cleanQuestion(messageBody);
      
      if (!pergunta) {
        await msg.reply("ü§ñ *InovaPro Smart Manager*\n\nDigite algo ap√≥s 'ia' ou 'inovapro', exemplo:\n‚Ä¢ 'ia quanto vendi ontem?'\n‚Ä¢ 'inovapro qual o produto mais vendido?'");
        return;
      }

      // Enviar resposta da IA
      const resposta = await askGroq(pergunta);
      await msg.reply(`ü§ñ *InovaPro Smart Manager*\n\n${resposta}\n\n_Sistema PDV InovaPro - INOVAPRO TECHNOLOGY_`);
      
      console.log(`‚úÖ Resposta da IA enviada para ${msg.from}`);
    }
  } catch (error) {
    console.error('‚ùå Erro no handler de mensagens da IA:', error);
    try {
      await msg.reply("‚ö†Ô∏è Ocorreu um erro ao processar sua mensagem. Tente novamente em alguns instantes.");
    } catch (replyError) {
      console.error('‚ùå Erro ao enviar mensagem de erro:', replyError);
    }
  }
});

console.log('ü§ñ M√≥dulo InovaPro Smart Manager ativado!');
console.log('üí¨ Bot responder√° a mensagens que come√ßam com "ia" ou "inovapro"');
// ============================================

// Mapeamento de formas de pagamento
const paymentMethodLabels = {
  'dinheiro': 'Dinheiro',
  'cartao_debito': 'Cart√£o de D√©bito',
  'cartao_credito': 'Cart√£o de Cr√©dito',
  'pix': 'PIX',
  'cheque': 'Cheque',
  'outro': 'Outro',
  'visa_debito': 'Visa D√©bito',
  'elo_debito': 'Elo D√©bito',
  'maestro_debito': 'Maestro D√©bito',
  'visa_credito': 'Visa Cr√©dito',
  'elo_credito': 'Elo Cr√©dito',
  'mastercard_credito': 'Mastercard Cr√©dito',
  'amex_hipercard_credsystem': 'Amex / Hipercard / Credsystem',
};

// Rota para envio de relat√≥rio
app.post('/send-report', async (req, res) => {
  try {
    if (!isClientReady) {
      return res.status(503).json({
        success: false,
        error: 'Bot do WhatsApp n√£o est√° conectado'
      });
    }

    const {
      user,
      startTime,
      endTime,
      totalSales,
      averageTicket,
      totalAmount,
      paymentSummary,
      groupId,
      pdfData,
      receiptNumber,
      whatsapp_number, // N√∫mero de WhatsApp do funcion√°rio
      shiftDuration // Dura√ß√£o do turno
    } = req.body;

    // Se whatsapp_number for fornecido, enviar para o PV. Caso contr√°rio, usar grupo
    let targetId;
    if (whatsapp_number) {
      // Formatar n√∫mero para o WhatsApp Web JS
      let cleanNumber = whatsapp_number.replace(/\D/g, '');

      // Se n√£o come√ßar com 55, adicionar
      if (!cleanNumber.startsWith('55')) {
        cleanNumber = '55' + cleanNumber;
      }

      // Adicionar @c.us se n√£o tiver
      targetId = cleanNumber.includes('@') ? cleanNumber : `${cleanNumber}@c.us`;
      console.log(`üì± Enviando relat√≥rio para PV: ${whatsapp_number} -> ${targetId}`);
    } else {
      // ID do grupo padr√£o (CAMINHO CERTO) - apenas se n√£o houver n√∫mero
      targetId = groupId || '120363407029045754@g.us';
      console.log(`üì± Enviando relat√≥rio para grupo: ${targetId}`);
    }

    const date = moment().tz('America/Sao_Paulo').format('DD/MM/YYYY');
    const startTimeFormatted = moment(startTime).tz('America/Sao_Paulo').format('HH:mm');
    const endTimeFormatted = moment(endTime).tz('America/Sao_Paulo').format('HH:mm');

    // Montar mensagem consolidada (ponto + vendas)
    let message = `üìã *Comprovante de Fechamento de Turno*\n\n`;
    message += `üë§ *Funcion√°rio:* ${user}\n`;
    message += `üìÖ *Data:* ${date}\n`;
    message += `üïê *Hor√°rio do Turno:* ${startTimeFormatted} √†s ${endTimeFormatted}\n`;
    if (shiftDuration) {
      message += `‚è±Ô∏è *Dura√ß√£o:* ${shiftDuration}\n`;
    }
    message += `\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    message += `üìä *RESUMO DE VENDAS*\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;

    if (totalSales === 0) {
      message += `üíµ *Total de Vendas:* R$ 0,00\n`;
      message += `üìÑ *Status:* Nenhuma venda registrada neste turno.\n\n`;
    } else {
      message += `üíµ *Total Vendido:* R$ ${parseFloat(totalAmount).toFixed(2)}\n`;
      message += `üìä *Quantidade de Vendas:* ${totalSales}\n`;
      message += `üìà *Ticket M√©dio:* R$ ${parseFloat(averageTicket).toFixed(2)}\n\n`;
      message += `üí≥ *Formas de Pagamento:*\n\n`;

      // Agrupar por categoria
      const debitoCategories = ['cartao_debito', 'visa_debito', 'elo_debito', 'maestro_debito'];
      const creditoCategories = ['cartao_credito', 'visa_credito', 'elo_credito', 'mastercard_credito', 'amex_hipercard_credsystem'];

      let hasDebito = false;
      let hasCredito = false;
      let debitoTotal = 0;
      let creditoTotal = 0;
      const outrosMetodos = [];

      // Separar formas de pagamento
      Object.entries(paymentSummary || {}).forEach(([method, data]) => {
        if (debitoCategories.includes(method)) {
          if (!hasDebito) {
            message += `*üîµ D√âBITO:*\n`;
            hasDebito = true;
          }
          const methodLabel = paymentMethodLabels[method] || method;
          message += `  ‚Ä¢ ${methodLabel}: ${data.count}x ‚Äî R$ ${parseFloat(data.amount).toFixed(2)}\n`;
          debitoTotal += parseFloat(data.amount);
        } else if (creditoCategories.includes(method)) {
          if (!hasCredito) {
            if (hasDebito) message += '\n';
            message += `*üü¢ CR√âDITO:*\n`;
            hasCredito = true;
          }
          const methodLabel = paymentMethodLabels[method] || method;
          message += `  ‚Ä¢ ${methodLabel}: ${data.count}x ‚Äî R$ ${parseFloat(data.amount).toFixed(2)}\n`;
          creditoTotal += parseFloat(data.amount);
        } else {
          outrosMetodos.push({ method, data });
        }
      });

      // Adicionar subtotais de d√©bito e cr√©dito
      if (hasDebito) {
        message += `  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
        message += `  *Subtotal D√©bito:* R$ ${debitoTotal.toFixed(2)}\n`;
      }
      if (hasCredito) {
        message += `  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
        message += `  *Subtotal Cr√©dito:* R$ ${creditoTotal.toFixed(2)}\n`;
      }

      // Adicionar outros m√©todos de pagamento (PIX, Dinheiro, etc)
      if (outrosMetodos.length > 0) {
        if (hasDebito || hasCredito) message += '\n';
        message += `*üî∂ OUTROS:*\n`;
        outrosMetodos.forEach(({ method, data }) => {
          const methodLabel = paymentMethodLabels[method] || method;
          message += `  ‚Ä¢ ${methodLabel}: ${data.count}x ‚Äî R$ ${parseFloat(data.amount).toFixed(2)}\n`;
        });
      }
      message += '\n';
    }

    message += `üè¢ *Local:* Loja de Conveni√™ncia CT P. Rodoil\n`;
    message += `üíº *CNPJ:* 28.769.272/0001-70\n`;
    message += `üìç *Registro INPI:* BR5120210029364\n\n`;
    message += `üí¨ _Obrigado pelo seu trabalho!_\n\n`;
    message += `ü§ñ _Sistema PDV InovaPro - INOVAPRO TECHNOLOGY_`;

    // Se h√° dados de PDF, criar arquivo PDF real e enviar como anexo
    if (pdfData && receiptNumber) {
      try {
        console.log('üìÑ Gerando PDF moderno para anexo...');
        
        // Criar diret√≥rio tempor√°rio se n√£o existir
        const tempDir = path.join(process.cwd(), 'temp');
        if (!fs.existsSync(tempDir)) {
          fs.mkdirSync(tempDir, { recursive: true });
        }

        // Verificar se pdfData tem o formato correto
        let reportText = '';
        if (typeof pdfData === 'string') {
          reportText = pdfData;
        } else if (pdfData.receiptText) {
          reportText = pdfData.receiptText;
        } else if (pdfData.data) {
          reportText = pdfData.data;
        } else {
          console.log('üìÑ Estrutura do pdfData:', JSON.stringify(pdfData, null, 2));
          reportText = JSON.stringify(pdfData, null, 2);
        }

        // Gerar PDF moderno usando html-pdf
        const pdfBuffer = await generateModernPDF(reportText, receiptNumber, paymentSummary);
        
        // Salvar PDF tempor√°rio
        const fileName = `relatorio_turno_${receiptNumber}.pdf`;
        const filePath = path.join(tempDir, fileName);
        
        // Escrever PDF no arquivo
        fs.writeFileSync(filePath, pdfBuffer);
        console.log(`üìÑ PDF criado: ${filePath}`);

        // Importar MessageMedia para envio de anexo
        const { MessageMedia } = pkg;
        const media = MessageMedia.fromFilePath(filePath);
        media.filename = fileName;

        // Enviar mensagem com anexo PDF
        await client.sendMessage(targetId, media, { caption: message });
        console.log('‚úÖ Relat√≥rio com PDF moderno enviado via WhatsApp!');

        // Limpar arquivo tempor√°rio ap√≥s envio
        setTimeout(() => {
          if (fs.existsSync(filePath)) {
            fs.unlinkSync(filePath);
            console.log('üóëÔ∏è Arquivo PDF tempor√°rio removido');
          }
        }, 5000);

      } catch (pdfError) {
        console.error('‚ùå Erro ao processar PDF:', pdfError);
        console.log('üìÑ Enviando apenas mensagem de texto...');
        // Se falhar com PDF, enviar apenas a mensagem
        await client.sendMessage(targetId, message);
        console.log('‚úÖ Relat√≥rio (sem PDF) enviado via WhatsApp!');
      }
    } else {
      console.log('üìÑ Nenhum PDF fornecido, enviando apenas mensagem...');
      // Enviar apenas mensagem se n√£o h√° PDF
      await client.sendMessage(targetId, message);
      console.log('‚úÖ Relat√≥rio enviado via WhatsApp!');
    }

    res.json({ success: true, message: 'Relat√≥rio enviado com sucesso!' });

  } catch (error) {
    console.error('‚ùå Erro ao enviar relat√≥rio:', error);
    res.status(500).json({ 
      success: false, 
      error: 'Erro interno do servidor',
      details: error.message 
    });
  }
});

// Rota para enviar notifica√ß√£o de ponto
app.post('/send-clock-notification', async (req, res) => {
  try {
    console.log('üì• Requisi√ß√£o recebida em /send-clock-notification');
    console.log('üì¶ Body:', JSON.stringify(req.body, null, 2));
    console.log('üîå Bot conectado?', isClientReady);

    if (!isClientReady) {
      console.error('‚ùå Bot n√£o conectado - rejeitando requisi√ß√£o');
      return res.status(503).json({
        success: false,
        error: 'Bot do WhatsApp n√£o est√° conectado'
      });
    }

    const { whatsapp_number, user_name, clock_time, type } = req.body;

    // Validar se o n√∫mero de WhatsApp foi fornecido
    if (!whatsapp_number) {
      return res.status(400).json({
        success: false,
        error: 'N√∫mero de WhatsApp n√£o fornecido'
      });
    }

    // Formatar n√∫mero para o WhatsApp Web JS
    // Remove todos os caracteres n√£o num√©ricos
    let cleanNumber = whatsapp_number.replace(/\D/g, '');

    // Se n√£o come√ßar com 55, adicionar
    if (!cleanNumber.startsWith('55')) {
      cleanNumber = '55' + cleanNumber;
    }

    // Adicionar @c.us se n√£o tiver
    const whatsappId = cleanNumber.includes('@') ? cleanNumber : `${cleanNumber}@c.us`;

    // Validar que n√£o √© um grupo (grupos terminam com @g.us)
    if (whatsappId.endsWith("@g.us")) {
      console.error(`‚ùå Tentativa de envio para grupo bloqueada: ${whatsappId}`);
      return res.status(400).json({
        success: false,
        error: "Envio para grupos n√£o √© permitido. Use apenas n√∫meros individuais."
      });
    }

    console.log(`üì± Enviando para: ${whatsapp_number} -> ${whatsappId}`);

    // Criar mensagem baseada no tipo (entrada, sa√≠da ou comprovante)
    let message = '';

    if (type === 'entrada') {
      message = `üìã *Comprovante de Ponto - PDV InovaPro*\n\n`;
      message += `üë§ *Funcion√°rio:* ${user_name}\n`;
      message += `üìÖ *Data:* ${moment(clock_time, 'DD/MM/YYYY [√†s] HH:mm:ss').format('DD/MM/YYYY')}\n`;
      message += `üïí *Hor√°rio:* ${moment(clock_time, 'DD/MM/YYYY [√†s] HH:mm:ss').format('HH:mm:ss')}\n`;
      message += `üè¢ *Local:* Loja de Conveni√™ncia CT P. Rodoil\n`;
      message += `üìÑ *Tipo:* Entrada no Turno\n\n`;
      message += `üíº *CNPJ:* 28.769.272/0001-70\n`;
      message += `üìç *Registro INPI:* BR5120210029364\n\n`;
      message += `üí¨ _Tenha um √≥timo dia de trabalho!_\n\n`;
      message += `ü§ñ _Sistema PDV InovaPro - INOVAPRO TECHNOLOGY_`;
    } else if (type === 'saida') {
      message = `üìã *Comprovante de Ponto - PDV InovaPro*\n\n`;
      message += `üë§ *Funcion√°rio:* ${user_name}\n`;
      message += `üìÖ *Data:* ${moment(clock_time, 'DD/MM/YYYY [√†s] HH:mm:ss').format('DD/MM/YYYY')}\n`;
      message += `üïí *Hor√°rio:* ${moment(clock_time, 'DD/MM/YYYY [√†s] HH:mm:ss').format('HH:mm:ss')}\n`;
      message += `üè¢ *Local:* Loja de Conveni√™ncia CT P. Rodoil\n`;
      message += `üìÑ *Tipo:* Sa√≠da do Turno\n\n`;
      message += `üíº *CNPJ:* 28.769.272/0001-70\n`;
      message += `üìç *Registro INPI:* BR5120210029364\n\n`;
      message += `üí¨ _Obrigado pelo seu trabalho hoje!_\n\n`;
      message += `ü§ñ _Sistema PDV InovaPro - INOVAPRO TECHNOLOGY_`;
    } else if (type === 'comprovante') {
      const { entrada, saida, totalHoras } = req.body;

      message = `üìã *Comprovante de Ponto - PDV InovaPro*\n\n`;
      message += `üë§ *Funcion√°rio:* ${user_name}\n`;
      message += `üìÖ *Data:* ${moment(clock_time, 'DD/MM/YYYY [√†s] HH:mm:ss').format('DD/MM/YYYY')}\n`;
      message += `üïí *Hor√°rio:* ${moment(clock_time, 'DD/MM/YYYY [√†s] HH:mm:ss').format('HH:mm:ss')}\n`;
      message += `üè¢ *Local:* Loja de Conveni√™ncia CT P. Rodoil\n`;
      message += `üìÑ *Tipo:* Sa√≠da do Turno\n`;
      message += `‚è±Ô∏è *Dura√ß√£o:* ${totalHoras}\n\n`;
      message += `üíº *CNPJ:* 28.769.272/0001-70\n`;
      message += `üìç *Registro INPI:* BR5120210029364\n\n`;
      message += `üí¨ _Turno finalizado com sucesso!_\n\n`;
      message += `ü§ñ _Sistema PDV InovaPro - INOVAPRO TECHNOLOGY_`;
    }

    // Enviar mensagem
    await client.sendMessage(whatsappId, message);
    console.log(`‚úÖ Notifica√ß√£o de ${type} enviada para ${whatsapp_number}`);

    res.json({ success: true, message: 'Notifica√ß√£o enviada com sucesso!' });

  } catch (error) {
    console.error('‚ùå Erro ao enviar notifica√ß√£o de ponto:', error);
    res.status(500).json({
      success: false,
      error: 'Erro interno do servidor',
      details: error.message
    });
  }
});

// Rota para verificar status do bot
app.get('/status', (req, res) => {
  res.json({
    connected: isClientReady,
    timestamp: moment().tz('America/Sao_Paulo').format('DD/MM/YYYY HH:mm:ss')
  });
});

// Rota para obter informa√ß√µes dos grupos
app.get('/groups', async (req, res) => {
  try {
    if (!isClientReady) {
      return res.status(503).json({ 
        success: false, 
        error: 'Bot n√£o est√° conectado' 
      });
    }

    const chats = await client.getChats();
    const groups = chats
      .filter(chat => chat.isGroup)
      .map(group => ({
        id: group.id._serialized,
        name: group.name,
        participantCount: group.participants.length
      }));

    res.json({ success: true, groups });
  } catch (error) {
    console.error('‚ùå Erro ao obter grupos:', error);
    res.status(500).json({ 
      success: false, 
      error: error.message 
    });
  }
});

// Fun√ß√£o para gerar PDF moderno e organizado
async function generateModernPDF(reportText, receiptNumber, paymentSummary) {
  let browser;
  try {
    const now = moment().tz('America/Sao_Paulo');
    
    // Template HTML moderno para o PDF
    const htmlTemplate = `
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            body {
                font-family: 'Arial', sans-serif;
                font-size: 12px;
                line-height: 1.4;
                color: #333;
                background: #fff;
            }
            
            .header {
                background: linear-gradient(135deg, #2980b9, #3498db);
                color: white;
                padding: 20px;
                text-align: center;
                margin-bottom: 20px;
            }
            
            .header h1 {
                font-size: 18px;
                font-weight: bold;
                margin-bottom: 5px;
            }
            
            .header h2 {
                font-size: 16px;
                font-weight: bold;
                margin-bottom: 10px;
            }
            
            .header h3 {
                font-size: 14px;
                font-weight: normal;
            }
            
            .company-info {
                background: #f8f9fa;
                padding: 15px;
                margin-bottom: 20px;
                border-left: 4px solid #2980b9;
            }
            
            .company-info p {
                margin: 3px 0;
                font-size: 11px;
                color: #555;
            }
            
            .report-info {
                margin-bottom: 20px;
            }
            
            .report-info p {
                margin: 5px 0;
                font-weight: bold;
            }
            
            .section {
                margin-bottom: 25px;
            }
            
            .section-title {
                background: #2980b9;
                color: white;
                padding: 10px 15px;
                font-weight: bold;
                font-size: 14px;
                margin-bottom: 10px;
            }
            
            .payment-table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 15px;
            }
            
            .payment-table th {
                background: #ecf0f1;
                padding: 8px;
                text-align: left;
                font-weight: bold;
                border: 1px solid #bdc3c7;
            }
            
            .payment-table td {
                padding: 8px;
                border: 1px solid #bdc3c7;
            }
            
            .payment-table tr:nth-child(even) {
                background: #f8f9fa;
            }
            
            .total-row {
                background: #e74c3c !important;
                color: white;
                font-weight: bold;
            }
            
            .total-row td {
                border-color: #c0392b;
            }
            
            .details-section {
                background: #f8f9fa;
                padding: 15px;
                border-radius: 5px;
                font-family: 'Courier New', monospace;
                font-size: 10px;
                line-height: 1.3;
            }
            
            .details-section .important {
                color: #e74c3c;
                font-weight: bold;
            }
            
            .footer {
                margin-top: 30px;
                padding: 15px;
                background: #ecf0f1;
                text-align: center;
                font-size: 10px;
                color: #7f8c8d;
            }
            
            .value-positive {
                color: #27ae60;
                font-weight: bold;
            }
            
            .value-negative {
                color: #e74c3c;
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <div class="header">
            <h1>CENTRO AUTOMOTIVO</h1>
            <h2>CAMINHO CERTO LTDA</h2>
            <h3>RELAT√ìRIO DE FECHAMENTO DE TURNO</h3>
        </div>
        
        <div class="company-info">
            <p><strong>Endere√ßo:</strong> AV MANUEL DOMINGOS PINTO - PQ ANHANGUERA S10 PAULO-SP</p>
            <p><strong>CEP:</strong> 05120-000 | <strong>CNPJ:</strong> 02.727.407/0001-40 | <strong>IE:</strong> 115.263.059.110</p>
        </div>
        
        <div class="report-info">
            <p><strong>Documento:</strong> ${receiptNumber}</p>
            <p><strong>Data/Hora:</strong> ${now.format('DD/MM/YYYY HH:mm:ss')}</p>
            <p><strong>Sistema:</strong> <span style="color: #2980b9;">Caminho Certo - INOVAPRO TECHNOLOGY</span></p>
        </div>
        
        ${paymentSummary && paymentSummary.length > 0 ? `
        <div class="section">
            <div class="section-title">RESUMO POR FORMA DE PAGAMENTO</div>
            <table class="payment-table">
                <thead>
                    <tr>
                        <th>Forma de Pagamento</th>
                        <th style="text-align: center;">Transa√ß√µes</th>
                        <th style="text-align: right;">Valor</th>
                    </tr>
                </thead>
                <tbody>
                    ${paymentSummary.map(item => {
                        const methodLabels = {
                            'dinheiro': 'Dinheiro',
                            'cartao_debito': 'Cart√£o D√©bito',
                            'cartao_credito': 'Cart√£o Cr√©dito',
                            'pix': 'PIX',
                            'outro': 'Outro'
                        };
                        const methodLabel = methodLabels[item.method] || item.method;
                        const amount = parseFloat(item.amount);
                        const valueClass = amount > 0 ? 'value-positive' : 'value-negative';
                        
                        return `
                        <tr>
                            <td>${methodLabel}</td>
                            <td style="text-align: center;">${item.count}x</td>
                            <td style="text-align: right;" class="${valueClass}">R$ ${amount.toFixed(2)}</td>
                        </tr>
                        `;
                    }).join('')}
                    <tr class="total-row">
                        <td><strong>TOTAL GERAL</strong></td>
                        <td style="text-align: center;"><strong>${paymentSummary.reduce((sum, item) => sum + item.count, 0)}x</strong></td>
                        <td style="text-align: right;"><strong>R$ ${paymentSummary.reduce((sum, item) => sum + parseFloat(item.amount), 0).toFixed(2)}</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
        ` : ''}
        
        ${reportText && reportText.trim() ? `
        <div class="section">
            <div class="section-title">DETALHES DO FECHAMENTO</div>
            <div class="details-section">
                ${reportText.split('\n').map(line => {
                    const trimmedLine = line.trim();
                    if (trimmedLine.includes('TOTAL') || trimmedLine.includes('DIFEREN√áA')) {
                        return `<div class="important">${trimmedLine}</div>`;
                    } else if (trimmedLine.includes('---') || trimmedLine.includes('===')) {
                        return '<div style="margin: 5px 0;"></div>';
                    } else if (trimmedLine) {
                        return `<div>${trimmedLine}</div>`;
                    } else {
                        return '<div style="margin: 3px 0;"></div>';
                    }
                }).join('')}
            </div>
        </div>
        ` : ''}
        
        <div class="footer">
            <p><strong>Documento gerado automaticamente pelo Sistema Caminho Certo</strong></p>
            <p>Gerado em: ${now.format('DD/MM/YYYY √†s HH:mm:ss')}</p>
        </div>
    </body>
    </html>
    `;

    // Inicializar puppeteer
    browser = await pdf.launch({
      headless: true,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-accelerated-2d-canvas',
        '--no-first-run',
        '--no-zygote',
        '--single-process',
        '--disable-gpu'
      ]
    });

    const page = await browser.newPage();
    
    // Configurar o conte√∫do HTML
    await page.setContent(htmlTemplate, { waitUntil: 'networkidle0' });
    
    // Gerar PDF
    const pdfBuffer = await page.pdf({
      format: 'A4',
      margin: {
        top: '0.5in',
        right: '0.5in',
        bottom: '0.5in',
        left: '0.5in'
      },
      printBackground: true
    });

    console.log('‚úÖ PDF gerado com sucesso usando Puppeteer!');
    return pdfBuffer;

  } catch (error) {
    console.error('‚ùå Erro ao gerar PDF:', error);
    throw error;
  } finally {
    if (browser) {
      await browser.close();
    }
  }
}

const PORT = process.env.PORT || 4000;

// Configurar HTTPS se houver certificados
const SSL_KEY_PATH = process.env.SSL_KEY_PATH;
const SSL_CERT_PATH = process.env.SSL_CERT_PATH;

if (SSL_KEY_PATH && SSL_CERT_PATH && fs.existsSync(SSL_KEY_PATH) && fs.existsSync(SSL_CERT_PATH)) {
  const httpsOptions = {
    key: fs.readFileSync(SSL_KEY_PATH),
    cert: fs.readFileSync(SSL_CERT_PATH)
  };

  https.createServer(httpsOptions, app).listen(PORT, () => {
    console.log(`üöÄ Servidor do bot rodando em https://ct.inovapro.cloud:${PORT}`);
    console.log('üì± Aguardando conex√£o com WhatsApp...');
  });
} else {
  console.log('‚ö†Ô∏è  Certificados SSL n√£o encontrados. Rodando em HTTP...');
  app.listen(PORT, () => {
    console.log(`üöÄ Servidor do bot rodando em http://localhost:${PORT}`);
    console.log('üì± Aguardando conex√£o com WhatsApp...');
  });
}

// Graceful shutdown
process.on('SIGINT', async () => {
  console.log('üõë Encerrando bot...');
  await client.destroy();
  process.exit(0);
});

process.on('SIGTERM', async () => {
  console.log('üõë Encerrando bot...');
  await client.destroy();
  process.exit(0);
});